---
title: 不推荐用宏表示常量和做函数
author: SG-Amadeus
date: 2024-08-06 00:07:01 +0800
categories: [CPP, CppTraps]
tags: [macro]
---
# 不推荐用宏表示常量和做函数

C++宏最重要是明确：”宏仅仅是文本替换！而且它是预编译时发生，在正常编译开始之前”。

宏就是编译器在预处理阶段进行的 文本替换 。 习惯上用大写字母表示<宏名>，目的是为了与变量名区分。

## 宏定义表示常量

宏定义表示常量最典型的代表便是 `#define PI 3.1415926`。

但是在cpp11标准之后是不推荐使用的，因为宏仅仅是文本替换！而且它是预编译时发生，在正常编译开始之前，在调试时已经进行文本替换，这可能使得调试过程变得复杂。

C++11引入了[`constexpr`关键字](https://en.cppreference.com/w/cpp/language/constexpr)，可以用于定义编译时常量表达式，这提供了更好的安全性和灵活性。

```cpp

constexprdouble PI = 3.14159265358979323846;

```

或者使用 `const`关键字来定义只读变量

```cpp

constdouble PI = 3.14159265358979323846;

```

## 宏定义做函数

调用宏比调用函数更有效率

宏定义的使用上像一个函数，但不是函数，它使用预处理器实现，没有了参数压栈，代码生成等一系列操作，因此效率很高。

但是不能进行参数有效性的检测，不能享受C++编译器严格类型检查的好处，并且会产生二义性。

一个简单的宏定义：

```cpp

#defineSQUARE(x) x * x

```

如果调用 `SQUARE(i++)`,那么i会先被递增两次，然后才相乘，并非预期的结果。

推荐使用 `inline`内联函数作为替代。内联函数不是在调用时发生控制转移，而是在编译时将函数体嵌入每一个调用处，编译时，类似宏替换，使用函数体替换调用处的函数名。

```cpp

inlineintsquare(intx) {

    return x * x;

}

```

内联函数能够进行参数类型检测，更加安全内联函数是在程序运行时展开，而且是进行参数传递，同时 `inline`关键字只是对编译器的一个定义，如果函数本地不符合内联函数的标准，编译器就会将这个函数当作是普通函数。

当然，内联函数也有自己的局限：为内联函数是在调用处展开，所以会使代码边长，占用更多内存。

所以一般内联函数尽量控制在10行以内，并且不要有循环或递归。

从C++11开始，`constexpr`也可以用来定义内联函数.

这些函数不仅在编译期间可以求值，而且编译器通常会自动内联它们，无需显式使用inline关键字。

## dowhile(0)的使用

linux内核和其他一些开源的代码中，经常会遇到这样的代码：

```cpp

do{

 ...

}while(0)

```

`do{...}while(0)`作用是辅助定义复杂的宏，避免引用的时候出错。

比如

```cpp

#defineDOSOMETHING() {\

        foo1(); \

        foo2(); \

        }\

```

我们习惯调用函数以后使用分号：

```cpp

DOSOMETHING();

```

而经过文本替换后就会变成这样:

```cpp

{

    foo1();

    foo2();

};

```

显然是存在语法上的错误

因此会采用 `do{...}while(0)`

```cpp

#defineDOSOMETHING() \

        do{ \

          foo1();\

          foo2();\

        }while(0)\

```

了解 `do{...}while(0)`能够帮助我们理解以前项目的源代码。

这在c和cpp11以前的版本是十分有用的，但是在cpp11以后并不推荐使用宏定义函数，推荐使用内联函数或者其他特性替代。

## 参考

[`constexpr`关键字](https://en.cppreference.com/w/cpp/language/constexpr)

[C++ 内联函数(inline)和宏定义(# define)的优劣及其区别](https://www.cnblogs.com/yinbiao/p/11606554.html)

[ do{...}while(0)的意义和用法](https://www.cnblogs.com/wicub/p/6031093.html)
